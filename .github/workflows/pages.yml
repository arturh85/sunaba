name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  publish-spacetimedb:
    name: Publish SpacetimeDB to Production
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install just
        uses: extractions/setup-just@v2

      - name: Install SpacetimeDB CLI
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://install.spacetimedb.com | sh -s -- -y
          echo "$HOME/.local/share/spacetime/bin" >> $GITHUB_PATH

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: spacetime-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: spacetime-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: spacetime-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Build SpacetimeDB module
        run: just spacetime-build

      - name: Publish to production with timeout handling
        id: publish_step
        run: |
          set +e  # Don't exit on error
          timeout 60 just spacetime-publish-prod sunaba
          EXIT_CODE=$?

          if [ $EXIT_CODE -eq 0 ]; then
            echo "✅ Published successfully"
            exit 0
          elif [ $EXIT_CODE -eq 124 ]; then
            echo "⚠️  Publish timed out after 60s, resetting and retrying..."
            just spacetime-reset-prod sunaba
            just spacetime-publish-prod sunaba
            if [ $? -eq 0 ]; then
              echo "✅ Published successfully after reset"
              exit 0
            else
              echo "❌ Publish failed after reset"
              exit 1
            fi
          else
            echo "❌ Publish failed with exit code $EXIT_CODE"
            exit 1
          fi

      - name: Set job summary
        if: always()
        run: |
          if [ "${{ steps.publish_step.outcome }}" = "success" ]; then
            echo "✅ SpacetimeDB published successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ **Warning:** SpacetimeDB publish failed (server may be offline)" >> $GITHUB_STEP_SUMMARY
            echo "GitHub Pages deployment will continue regardless" >> $GITHUB_STEP_SUMMARY
          fi

  build:
    name: Build Documentation and WASM
    runs-on: ubuntu-latest
    needs: publish-spacetimedb
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.x

      - name: Build Documentation
        run: |
          pip install zensical
          zensical build --clean

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: wasm-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: wasm-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: wasm-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache wasm-bindgen-cli
        id: cache-wasm-bindgen
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/wasm-bindgen
          key: wasm-bindgen-0.2.106

      - name: Install wasm-bindgen-cli
        if: steps.cache-wasm-bindgen.outputs.cache-hit != 'true'
        run: cargo install wasm-bindgen-cli --version 0.2.106

      - name: Create web/pkg directory
        run: mkdir -p web/pkg

      - name: Build WASM
        run: |
          cargo build --release --target wasm32-unknown-unknown --no-default-features
          wasm-bindgen --out-dir web/pkg --target web --no-typescript target/wasm32-unknown-unknown/release/sunaba.wasm

      - name: Combine Documentation and WASM
        run: |
          mkdir -p site/game
          cp -r web/* site/game/

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'site'

  deploy:
    name: Deploy to GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
